name: Update Package Repos

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to update packages for (e.g., 1.0.0)'
        required: true
      dry_run:
        description: 'Dry run (no PR creation)'
        required: false
        default: 'false'

# Package updates should not be cancelled mid-flight
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

env:
  # Package repository names
  HOMEBREW_TAP_REPO: process-triage/homebrew-tap
  SCOOP_BUCKET_REPO: process-triage/scoop-bucket
  # Dedicated Winget manifest repo/fork. Can be set to microsoft/winget-pkgs
  # when using a token with rights to push a PR branch.
  WINGET_PKGS_REPO: process-triage/winget-pkgs

jobs:
  # ==========================================================================
  # Generate package files from release
  # ==========================================================================
  generate-packages:
    name: Generate Package Files
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      version: ${{ steps.version.outputs.version }}
      winget_generated: ${{ steps.winget.outputs.generated }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Determine version
        id: version
        run: |
          if [[ "${{ github.event_name }}" == "release" ]]; then
            version="${{ github.event.release.tag_name }}"
            version="${version#v}"  # Remove 'v' prefix
          else
            version="${{ github.event.inputs.version }}"
          fi
          echo "version=$version" >> $GITHUB_OUTPUT
          echo "Using version: $version"

      - name: Download checksums from release
        run: |
          version="${{ steps.version.outputs.version }}"

          # Download checksums file from GitHub release
          curl -fsSL -o checksums.sha256 \
            "https://github.com/${{ github.repository }}/releases/download/v${version}/checksums.sha256"

          echo "Downloaded checksums:"
          cat checksums.sha256

      - name: Generate formula and manifest
        id: generate
        run: |
          version="${{ steps.version.outputs.version }}"
          mkdir -p dist/packages

          ./scripts/package/generate_packages.sh "$version" checksums.sha256 dist/packages

          echo "Generated files:"
          ls -la dist/packages/

      - name: Detect Winget manifest generation
        id: winget
        run: |
          if [[ -f dist/packages/pt.winget.yaml ]] \
            && [[ -f dist/packages/pt.winget.installer.yaml ]] \
            && [[ -f dist/packages/pt.winget.locale.en-US.yaml ]]; then
            echo "generated=true" >> "$GITHUB_OUTPUT"
            echo "Winget manifests present."
          else
            echo "generated=false" >> "$GITHUB_OUTPUT"
            echo "Winget manifests not present (Windows assets likely missing)."
          fi

      - name: Upload package files
        uses: actions/upload-artifact@v4
        with:
          name: package-files
          path: dist/packages/
          retention-days: 7

  # ==========================================================================
  # Update Homebrew tap (create PR)
  # ==========================================================================
  update-homebrew:
    name: Update Homebrew Tap
    needs: generate-packages
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: github.event.inputs.dry_run != 'true'

    steps:
      - name: Download package files
        uses: actions/download-artifact@v4
        with:
          name: package-files
          path: packages

      - name: Checkout Homebrew tap
        uses: actions/checkout@v4
        with:
          repository: ${{ env.HOMEBREW_TAP_REPO }}
          token: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          path: tap

      - name: Update formula
        run: |
          version="${{ needs.generate-packages.outputs.version }}"

          # Copy new formula
          cp packages/pt.rb tap/Formula/pt.rb

          # Create commit message
          cd tap
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Check if there are changes
          if git diff --quiet; then
            echo "No changes to formula"
            exit 0
          fi

          # Create branch and commit
          branch="update-pt-${version}"
          git checkout -b "$branch"
          git add Formula/pt.rb
          git commit -m "Update pt to ${version}"

          echo "branch=$branch" >> $GITHUB_ENV

      - name: Create PR to Homebrew tap
        if: env.branch != ''
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          path: tap
          branch: ${{ env.branch }}
          title: "Update pt to ${{ needs.generate-packages.outputs.version }}"
          body: |
            Automated update of pt formula to version ${{ needs.generate-packages.outputs.version }}.

            Release: https://github.com/${{ github.repository }}/releases/tag/v${{ needs.generate-packages.outputs.version }}

            **Installation:**
            ```bash
            brew tap process-triage/tap
            brew install pt
            ```
          labels: automated,release

  # ==========================================================================
  # Update Scoop bucket (create PR)
  # ==========================================================================
  update-scoop:
    name: Update Scoop Bucket
    needs: generate-packages
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: github.event.inputs.dry_run != 'true'

    steps:
      - name: Download package files
        uses: actions/download-artifact@v4
        with:
          name: package-files
          path: packages

      - name: Checkout Scoop bucket
        uses: actions/checkout@v4
        with:
          repository: ${{ env.SCOOP_BUCKET_REPO }}
          token: ${{ secrets.SCOOP_BUCKET_TOKEN }}
          path: bucket

      - name: Update manifest
        run: |
          version="${{ needs.generate-packages.outputs.version }}"

          # Copy new manifest
          cp packages/pt.json bucket/bucket/pt.json

          # Create commit
          cd bucket
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Check if there are changes
          if git diff --quiet; then
            echo "No changes to manifest"
            exit 0
          fi

          # Create branch and commit
          branch="update-pt-${version}"
          git checkout -b "$branch"
          git add bucket/pt.json
          git commit -m "Update pt to ${version}"

          echo "branch=$branch" >> $GITHUB_ENV

      - name: Create PR to Scoop bucket
        if: env.branch != ''
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.SCOOP_BUCKET_TOKEN }}
          path: bucket
          branch: ${{ env.branch }}
          title: "Update pt to ${{ needs.generate-packages.outputs.version }}"
          body: |
            Automated update of pt manifest to version ${{ needs.generate-packages.outputs.version }}.

            Release: https://github.com/${{ github.repository }}/releases/tag/v${{ needs.generate-packages.outputs.version }}

            **Installation:**
            ```powershell
            scoop bucket add process-triage https://github.com/process-triage/scoop-bucket
            scoop install pt
            ```
          labels: automated,release

  # ==========================================================================
  # Update Winget package repo (create PR)
  # ==========================================================================
  update-winget:
    name: Update Winget Package Repo
    needs: [generate-packages, test-packages]
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: github.event.inputs.dry_run != 'true' && needs.generate-packages.outputs.winget_generated == 'true' && secrets.WINGET_PKGS_TOKEN != ''

    steps:
      - name: Download package files
        uses: actions/download-artifact@v4
        with:
          name: package-files
          path: packages

      - name: Checkout Winget repo
        uses: actions/checkout@v4
        with:
          repository: ${{ env.WINGET_PKGS_REPO }}
          token: ${{ secrets.WINGET_PKGS_TOKEN }}
          path: winget

      - name: Update Winget manifests
        run: |
          version="${{ needs.generate-packages.outputs.version }}"
          manifest_dir="winget/manifests/p/ProcessTriage/pt/${version}"

          mkdir -p "$manifest_dir"

          cp packages/pt.winget.yaml "${manifest_dir}/ProcessTriage.pt.yaml"
          cp packages/pt.winget.installer.yaml "${manifest_dir}/ProcessTriage.pt.installer.yaml"
          cp packages/pt.winget.locale.en-US.yaml "${manifest_dir}/ProcessTriage.pt.locale.en-US.yaml"

          # Defensive check for missed substitutions.
          if grep -R --line-number '{{' "$manifest_dir"; then
            echo "::error::Unreplaced template placeholder detected in Winget manifests"
            exit 1
          fi

          cd winget
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          if git diff --quiet; then
            echo "No changes to Winget manifests"
            exit 0
          fi

          branch="update-process-triage-winget-${version}"
          git checkout -b "$branch"
          git add "manifests/p/ProcessTriage/pt/${version}"
          git commit -m "Add ProcessTriage.pt ${version}"

          echo "branch=$branch" >> "$GITHUB_ENV"

      - name: Create PR to Winget repo
        if: env.branch != ''
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.WINGET_PKGS_TOKEN }}
          path: winget
          branch: ${{ env.branch }}
          title: "Add ProcessTriage.pt ${{ needs.generate-packages.outputs.version }}"
          body: |
            Automated update of ProcessTriage.pt Winget manifests to version ${{ needs.generate-packages.outputs.version }}.

            Release: https://github.com/${{ github.repository }}/releases/tag/v${{ needs.generate-packages.outputs.version }}

            If this repo is a fork/mirror, open a follow-up PR to `microsoft/winget-pkgs`.
          labels: automated,release,winget

  # ==========================================================================
  # Test package installation (dry run validation)
  # ==========================================================================
  test-packages:
    name: Validate Package Files
    needs: generate-packages
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Download package files
        uses: actions/download-artifact@v4
        with:
          name: package-files
          path: packages

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'

      - name: Validate Homebrew formula syntax
        run: |
          echo "Validating Ruby syntax..."
          ruby -c packages/pt.rb
          echo "Formula syntax: OK"

      - name: Validate Scoop manifest JSON
        run: |
          echo "Validating JSON syntax..."
          jq . packages/pt.json > /dev/null
          echo "Manifest syntax: OK"

          # Validate required fields
          echo "Checking required fields..."
          jq -e '.version' packages/pt.json > /dev/null
          jq -e '.description' packages/pt.json > /dev/null
          jq -e '.homepage' packages/pt.json > /dev/null
          jq -e '.architecture."64bit".url' packages/pt.json > /dev/null
          jq -e '.architecture."64bit".hash' packages/pt.json > /dev/null
          echo "All required fields present"

      - name: Validate Winget manifests (optional)
        run: |
          if [[ ! -f packages/pt.winget.yaml ]]; then
            echo "Winget manifests not generated for this release (Windows artifacts missing)"
            exit 0
          fi

          for file in \
            packages/pt.winget.yaml \
            packages/pt.winget.installer.yaml \
            packages/pt.winget.locale.en-US.yaml
          do
            if [[ ! -f "$file" ]]; then
              echo "::error::Missing expected Winget file: $file"
              exit 1
            fi
            if grep -q '{{' "$file"; then
              echo "::error::Unreplaced placeholder found in $file"
              exit 1
            fi
          done

          grep -q '^PackageIdentifier: ProcessTriage\.pt$' packages/pt.winget.yaml
          grep -q '^ManifestType: version$' packages/pt.winget.yaml
          grep -q '^ManifestType: installer$' packages/pt.winget.installer.yaml
          grep -Eq '^[[:space:]]*-[[:space:]]*Architecture:[[:space:]]*x64$' packages/pt.winget.installer.yaml
          grep -q '^ManifestType: defaultLocale$' packages/pt.winget.locale.en-US.yaml
          echo "Winget manifests: OK"

      - name: Validate URLs are reachable
        run: |
          version="${{ needs.generate-packages.outputs.version }}"

          echo "Checking release URLs..."

          # Linux x86_64 is expected for normal releases but can be absent for
          # manual dry-run workflow_dispatch calls against placeholder versions.
          linux_url="https://github.com/${{ github.repository }}/releases/download/v${version}/pt-core-linux-x86_64-${version}.tar.gz"
          if curl --head --fail --silent "$linux_url" > /dev/null; then
            echo "  Linux x86_64: OK"
          else
            echo "  Linux x86_64: MISSING (allowed for dry runs)"
          fi

          if [[ ! -f packages/pt.winget.installer.yaml ]]; then
            echo "Winget URL validation skipped (no Winget manifests generated)."
            exit 0
          fi

          extract_installer_url() {
            local arch="$1"
            awk -v arch="$arch" '
              $0 ~ "^[[:space:]]*-[[:space:]]*Architecture:[[:space:]]*" arch "$" {
                in_target = 1
                next
              }
              in_target && $0 ~ /^[[:space:]]*InstallerUrl:[[:space:]]*/ {
                line = $0
                sub(/^[[:space:]]*InstallerUrl:[[:space:]]*/, "", line)
                gsub(/[[:space:]]+$/, "", line)
                print line
                exit
              }
              in_target && $0 ~ /^[[:space:]]*-[[:space:]]*Architecture:[[:space:]]*/ {
                in_target = 0
              }
            ' packages/pt.winget.installer.yaml
          }

          # x64 is required whenever Winget manifests are generated.
          x64_url=$(extract_installer_url x64)
          if [[ -z "$x64_url" ]]; then
            echo "::error::Missing x64 InstallerUrl in pt.winget.installer.yaml"
            exit 1
          fi
          if curl --head --fail --silent "$x64_url" > /dev/null; then
            echo "  Winget Windows x64 URL: OK"
          else
            echo "::error::Winget Windows x64 URL is not reachable: $x64_url"
            exit 1
          fi

          # arm64 is optional. If present, it must resolve.
          arm64_url=$(extract_installer_url arm64 || true)
          if [[ -n "$arm64_url" ]]; then
            if curl --head --fail --silent "$arm64_url" > /dev/null; then
              echo "  Winget Windows arm64 URL: OK"
            else
              echo "::error::Winget Windows arm64 URL is not reachable: $arm64_url"
              exit 1
            fi
          else
            echo "  Winget Windows arm64 URL: not present (optional)"
          fi
