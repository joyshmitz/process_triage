name: Test Suite

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # ==========================================================================
  # Unit Tests - cargo test --workspace
  # ==========================================================================
  unit-tests:
    name: Unit Tests (${{ matrix.os }} / ${{ matrix.rust }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
        rust: [stable, beta]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust toolchain (${{ matrix.rust }})
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ matrix.rust }}

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: "crates -> target"
          key: ${{ matrix.os }}-${{ matrix.rust }}

      - name: Run unit tests
        run: |
          echo "::group::Running unit tests"
          cargo test --workspace --lib --bins 2>&1 | tee test-output.log
          echo "::endgroup::"

      - name: Upload test logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: unit-test-logs-${{ matrix.os }}-${{ matrix.rust }}
          path: |
            test-output.log
            target/test-logs/
          retention-days: 14

  # ==========================================================================
  # Integration Tests - cargo test --test 'cli_*'
  # ==========================================================================
  integration-tests:
    name: Integration Tests (${{ matrix.os }} / ${{ matrix.rust }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
        rust: [stable, beta]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust toolchain (${{ matrix.rust }})
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ matrix.rust }}

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: "crates -> target"
          key: ${{ matrix.os }}-${{ matrix.rust }}

      - name: Build binaries first
        run: cargo build --workspace

      - name: Run CLI integration tests
        run: |
          echo "::group::Running integration tests"
          cargo test --test 'cli_*' -- --test-threads=1 2>&1 | tee integration-output.log
          echo "::endgroup::"

      - name: Upload test logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-logs-${{ matrix.os }}-${{ matrix.rust }}
          path: |
            integration-output.log
            target/test-logs/
          retention-days: 14

  # ==========================================================================
  # E2E Tests - cargo test --test 'e2e_*'
  # ==========================================================================
  e2e-tests:
    name: E2E Tests (${{ matrix.os }} / ${{ matrix.rust }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
        rust: [stable, beta]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust toolchain (${{ matrix.rust }})
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ matrix.rust }}

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: "crates -> target"
          key: ${{ matrix.os }}-${{ matrix.rust }}

      - name: Build binaries first
        run: cargo build --workspace

      - name: Run E2E workflow tests
        run: |
          echo "::group::Running E2E tests"
          cargo test --test 'e2e_*' -- --test-threads=1 2>&1 | tee e2e-output.log
          echo "::endgroup::"

      - name: Upload test logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-test-logs-${{ matrix.os }}-${{ matrix.rust }}
          path: |
            e2e-output.log
            target/test-logs/
          retention-days: 14

  # ==========================================================================
  # BATS Tests - bats test/
  # ==========================================================================
  bats-tests:
    name: BATS Tests (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Bash 5 (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install bash
          echo "/opt/homebrew/bin" >> $GITHUB_PATH
          /opt/homebrew/bin/bash --version

      - name: Install BATS
        run: |
          git clone --depth 1 https://github.com/bats-core/bats-core.git
          cd bats-core
          sudo ./install.sh /usr/local

      - name: Install gum (optional)
        run: |
          if [[ "$RUNNER_OS" == "Linux" ]]; then
            sudo mkdir -p /etc/apt/keyrings
            curl -fsSL https://repo.charm.sh/apt/gpg.key | sudo gpg --dearmor -o /etc/apt/keyrings/charm.gpg
            echo "deb [signed-by=/etc/apt/keyrings/charm.gpg] https://repo.charm.sh/apt/ * *" | sudo tee /etc/apt/sources.list.d/charm.list
            sudo apt update && sudo apt install -y gum
          else
            brew install gum
          fi
        continue-on-error: true

      - name: Run BATS tests
        run: |
          echo "::group::Running BATS tests"
          bats --tap test/ 2>&1 | tee bats-output.log
          echo "::endgroup::"
        env:
          TERM: xterm-256color

      - name: Upload test logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: bats-test-logs-${{ matrix.os }}
          path: |
            bats-output.log
            test/
          retention-days: 14

  # ==========================================================================
  # Schema Validation Tests
  # ==========================================================================
  schema-tests:
    name: Schema Validation (ubuntu / stable)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: "crates -> target"

      - name: Build binaries first
        run: cargo build --workspace

      - name: Run schema validation tests
        run: |
          echo "::group::Running schema validation tests"
          cargo test --test schema_validation 2>&1 | tee schema-output.log
          echo "::endgroup::"

      - name: Upload test logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: schema-test-logs
          path: schema-output.log
          retention-days: 14

  # ==========================================================================
  # Exit Code Tests
  # ==========================================================================
  exit-code-tests:
    name: Exit Code Tests (ubuntu / stable)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: "crates -> target"

      - name: Build binaries first
        run: cargo build --workspace

      - name: Run exit code tests
        run: |
          echo "::group::Running exit code tests"
          cargo test --test exit_codes_comprehensive 2>&1 | tee exitcode-output.log
          echo "::endgroup::"

      - name: Upload test logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: exitcode-test-logs
          path: exitcode-output.log
          retention-days: 14

  # ==========================================================================
  # Test Timing Report
  # ==========================================================================
  timing-report:
    name: Generate Timing Report
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests, e2e-tests, bats-tests]
    if: always()

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Generate timing summary
        run: |
          echo "# Test Timing Report" > timing-report.md
          echo "" >> timing-report.md
          echo "Generated at: $(date -u +%Y-%m-%dT%H:%M:%SZ)" >> timing-report.md
          echo "" >> timing-report.md
          echo "## Artifact Sizes" >> timing-report.md
          echo "" >> timing-report.md
          if [ -d artifacts ]; then
            for dir in artifacts/*/; do
              if [ -d "$dir" ]; then
                size=$(du -sh "$dir" | cut -f1)
                name=$(basename "$dir")
                echo "- $name: $size" >> timing-report.md
              fi
            done
          fi
          cat timing-report.md

      - name: Upload timing report
        uses: actions/upload-artifact@v4
        with:
          name: timing-report
          path: timing-report.md
          retention-days: 14
