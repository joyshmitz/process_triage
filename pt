#!/usr/bin/env bash
#
# pt - Process Triage Wrapper
#
# This script wraps the 'pt-core' Alien Technology Artifact.
# It ensures the environment is set up correctly and forwards all arguments.
#
set -euo pipefail

readonly VERSION="2.0.1"

# ══════════════════════════════════════════════════════════════════════════════
# Configuration
# ══════════════════════════════════════════════════════════════════════════════

readonly PT_CORE_BIN="pt-core"
readonly INSTALL_URL="https://raw.githubusercontent.com/Dicklesworthstone/process_triage/master/install.sh"

# Locations to search for pt-core
readonly SEARCH_PATHS=(
    "$(dirname "$0")/pt-core"
    "$(dirname "$0")/target/release/pt-core"
    "$HOME/.local/bin/pt-core"
    "/usr/local/bin/pt-core"
    "/usr/bin/pt-core"
)

# ══════════════════════════════════════════════════════════════════════════════
# Discovery
# ══════════════════════════════════════════════════════════════════════════════

find_pt_core() {
    # Check explicit override
    if [[ -n "${PT_CORE_PATH:-}" ]]; then
        if [[ -x "$PT_CORE_PATH" ]]; then
            echo "$PT_CORE_PATH"
            return 0
        fi
    fi

    # Check search paths
    for path in "${SEARCH_PATHS[@]}"; do
        if [[ -x "$path" ]]; then
            echo "$path"
            return 0
        fi
    done

    # Check PATH
    if command -v "$PT_CORE_BIN" &>/dev/null; then
        command -v "$PT_CORE_BIN"
        return 0
    fi

    return 1
}

# ══════════════════════════════════════════════════════════════════════════════
# Main
# ══════════════════════════════════════════════════════════════════════════════

main() {
    local pt_core
    pt_core=$(find_pt_core) || {
        echo "Error: 'pt-core' binary not found." >&2
        echo "Please install it via:" >&2
        echo "  curl -fsSL $INSTALL_URL | bash" >&2
        echo "  # or" >&2
        echo "  wget -qO- $INSTALL_URL | bash" >&2
        exit 1
    }

    local installer_cmd
    if command -v curl &>/dev/null; then
        installer_cmd="curl -fsSL $INSTALL_URL | bash"
    elif command -v wget &>/dev/null; then
        installer_cmd="wget -qO- $INSTALL_URL | bash"
    else
        installer_cmd=""
    fi

    # Special handling for 'update' (wrapper-level)
    if [[ "${1:-}" == "update" ]]; then
        echo "Updating Process Triage..."
        if [[ -z "$installer_cmd" ]]; then
            echo "Error: neither curl nor wget is available to run installer." >&2
            exit 1
        fi
        bash -c "set -euo pipefail; $installer_cmd"
        exit $?
    fi

    if [[ "${1:-}" == "--version" || "${1:-}" == "-V" ]]; then
        printf 'pt %s\n' "$VERSION"
        exit 0
    fi

    # Forward to pt-core
    # We use 'exec' to replace the shell process
    exec "$pt_core" "$@"
}

main "$@"
