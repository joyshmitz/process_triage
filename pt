#!/usr/bin/env bash
#
# pt - Process Triage Wrapper
#
# This script wraps the 'pt-core' Alien Technology Artifact.
# It ensures the environment is set up correctly and forwards all arguments.
#
set -euo pipefail

readonly VERSION="2.0.3"

# ══════════════════════════════════════════════════════════════════════════════
# Configuration
# ══════════════════════════════════════════════════════════════════════════════

readonly PT_CORE_BIN="pt-core"
readonly INSTALL_BASE_URL="https://raw.githubusercontent.com/Dicklesworthstone/process_triage"
readonly INSTALL_URL="${INSTALL_BASE_URL}/main/install.sh"
# Populated in release artifacts to pin expected installer signing key.
readonly DEFAULT_RELEASE_PUBLIC_KEY_FINGERPRINT=""

# Locations to search for pt-core
readonly SEARCH_PATHS=(
    "$(dirname "$0")/pt-core"
    "$(dirname "$0")/target/release/pt-core"
    "$HOME/.local/bin/pt-core"
    "/usr/local/bin/pt-core"
    "/usr/bin/pt-core"
)

# ══════════════════════════════════════════════════════════════════════════════
# Discovery
# ══════════════════════════════════════════════════════════════════════════════

find_pt_core() {
    # Check explicit override
    if [[ -n "${PT_CORE_PATH:-}" ]]; then
        if [[ -x "$PT_CORE_PATH" ]]; then
            echo "$PT_CORE_PATH"
            return 0
        fi
    fi

    # Check search paths
    for path in "${SEARCH_PATHS[@]}"; do
        if [[ -x "$path" ]]; then
            echo "$path"
            return 0
        fi
    done

    # Check PATH
    if command -v "$PT_CORE_BIN" &>/dev/null; then
        command -v "$PT_CORE_BIN"
        return 0
    fi

    return 1
}

fetch_latest_release_version() {
    local version_url="${INSTALL_BASE_URL}/main/VERSION"
    local version=""

    if command -v curl &>/dev/null; then
        version="$(curl -fsSL "$version_url" 2>/dev/null | tr -d '[:space:]')" || return 1
    elif command -v wget &>/dev/null; then
        version="$(wget -qO- "$version_url" 2>/dev/null | tr -d '[:space:]')" || return 1
    else
        return 1
    fi

    # Accept semver-like release tags only (e.g., 2.0.3, 2.0.3-rc1, 2.0.3+build).
    if [[ ! "$version" =~ ^[0-9]+\.[0-9]+\.[0-9]+([.-][0-9A-Za-z]+)*(\+[0-9A-Za-z.-]+)?$ ]]; then
        return 1
    fi

    printf '%s\n' "$version"
}

# ══════════════════════════════════════════════════════════════════════════════
# UI mode selection
# ══════════════════════════════════════════════════════════════════════════════

detect_auto_ui_mode() {
    if [[ ! -t 0 || ! -t 1 ]]; then
        printf 'shell\n'
        return 0
    fi

    if [[ "${CI:-}" == "true" || "${CI:-}" == "1" ]]; then
        printf 'shell\n'
        return 0
    fi

    if [[ "${TERM:-}" == "dumb" ]]; then
        printf 'shell\n'
        return 0
    fi

    printf 'tui\n'
}

resolve_ui_mode() {
    local cli_mode="${1:-}"
    local env_mode="${PT_UI_MODE:-auto}"

    if [[ "$cli_mode" == "shell" || "$cli_mode" == "tui" ]]; then
        printf '%s\n' "$cli_mode"
        return 0
    fi

    case "$env_mode" in
        shell|tui)
            printf '%s\n' "$env_mode"
            return 0
            ;;
        auto|"")
            ;;
        *)
            ;;
    esac

    detect_auto_ui_mode
}

# ══════════════════════════════════════════════════════════════════════════════
# Main
# ══════════════════════════════════════════════════════════════════════════════

main() {
    local cli_mode=""
    local -a forwarded_args=()
    local arg

    for arg in "$@"; do
        case "$arg" in
            --shell)
                if [[ "$cli_mode" == "tui" ]]; then
                    echo "Error: --shell and --tui cannot be used together." >&2
                    exit 2
                fi
                cli_mode="shell"
                ;;
            --tui)
                if [[ "$cli_mode" == "shell" ]]; then
                    echo "Error: --shell and --tui cannot be used together." >&2
                    exit 2
                fi
                cli_mode="tui"
                ;;
            *)
                forwarded_args+=("$arg")
                ;;
        esac
    done

    local selected_ui_mode
    selected_ui_mode="$(resolve_ui_mode "$cli_mode")"
    export PT_UI_MODE="$selected_ui_mode"

    local pt_core
    pt_core=$(find_pt_core) || {
        echo "Error: 'pt-core' binary not found." >&2
        echo "Please install it via:" >&2
        echo "  curl -fsSL $INSTALL_URL | bash" >&2
        echo "  # or" >&2
        echo "  wget -qO- $INSTALL_URL | bash" >&2
        exit 1
    }

    # Special handling for 'update' (wrapper-level)
    if [[ "${forwarded_args[0]:-}" == "update" ]]; then
        local target_version
        if target_version="$(fetch_latest_release_version)"; then
            :
        else
            target_version="$VERSION"
            echo "Warning: could not resolve latest VERSION; falling back to v${VERSION} installer." >&2
        fi
        local target_install_url="${INSTALL_BASE_URL}/v${target_version}/install.sh"

        echo "Updating Process Triage to v${target_version}..."
        if command -v curl &>/dev/null; then
            if [[ -n "${DEFAULT_RELEASE_PUBLIC_KEY_FINGERPRINT:-}" ]]; then
                curl -fsSL "$target_install_url" | env VERIFY=1 PT_RELEASE_PUBLIC_KEY_FINGERPRINT="${DEFAULT_RELEASE_PUBLIC_KEY_FINGERPRINT}" bash
            else
                curl -fsSL "$target_install_url" | env VERIFY=1 bash
            fi
        elif command -v wget &>/dev/null; then
            if [[ -n "${DEFAULT_RELEASE_PUBLIC_KEY_FINGERPRINT:-}" ]]; then
                wget -qO- "$target_install_url" | env VERIFY=1 PT_RELEASE_PUBLIC_KEY_FINGERPRINT="${DEFAULT_RELEASE_PUBLIC_KEY_FINGERPRINT}" bash
            else
                wget -qO- "$target_install_url" | env VERIFY=1 bash
            fi
        else
            echo "Error: neither curl nor wget is available to run installer." >&2
            exit 1
        fi
        exit $?
    fi

    if [[ "${forwarded_args[0]:-}" == "--version" || "${forwarded_args[0]:-}" == "-V" ]]; then
        printf 'pt %s\n' "$VERSION"
        exit 0
    fi

    # Forward to pt-core
    # We use 'exec' to replace the shell process
    exec "$pt_core" "${forwarded_args[@]}"
}

main "$@"
